{% extends "base.html" %}
{% block title %}Sentences for {{ link_url }}{% endblock %}
{% block content %}
<a href="{{ url_for('index') }}" class="btn btn-link">&larr; Back</a>
<h3>Sentences for <a href="{{ link_url }}" target="_blank">{{ link_url }}</a></h3>
<p class="text-muted">Showing {{start}}â€“{{end}} of {{total}} (page {{page}} / {{total_pages}})</p>

<!-- Filter + Page size (TOP) -->
<form method="get" class="mb-3 d-flex align-items-center gap-3">
  <input type="hidden" name="page" value="1">

  <!-- Status filter -->
  <label for="status" class="mb-0">Filter:</label>
  <select name="status" id="status" class="form-select form-select-sm" style="max-width:150px;"
          onchange="this.form.submit()">
    <option value="" {% if not status_filter %}selected{% endif %}>All</option>
    <option value="new" {% if status_filter=='new' %}selected{% endif %}>New</option>
    <option value="reviewed" {% if status_filter=='reviewed' %}selected{% endif %}>Reviewed</option>
    <option value="rejected" {% if status_filter=='rejected' %}selected{% endif %}>Rejected</option>
  </select>

  <!-- Page size -->
  <label for="page_size" class="mb-0">Rows per page:</label>
  <select name="page_size" id="page_size" class="form-select form-select-sm" style="max-width:100px;"
          onchange="this.form.submit()">
    {% for size in [10,25,50,100] %}
      <option value="{{ size }}" {% if page_size|int == size %}selected{% endif %}>{{ size }}</option>
    {% endfor %}
  </select>
</form>

<!-- Top action buttons -->
<div class="mb-3">
  <button id="mark-reviewed" class="btn btn-success btn-sm">Mark Reviewed</button>
  <button id="mark-rejected" class="btn btn-warning btn-sm">Mark Rejected</button>
  <button id="mark-new" class="btn btn-secondary btn-sm">Mark New</button>
  <button id="delete-selected" class="btn btn-danger btn-sm">Delete Selected</button>
</div>

<form id="sentences-form">
  <table class="table table-bordered">
    <thead class="table-light">
      <tr>
        <th><input id="select-all-top" type="checkbox"></th>
        <th>Sentence</th>
        <th style="width:220px;">Actions</th>
      </tr>
    </thead>
    <tbody>
    {% if sentences %}
      {% for s in sentences %}
        <tr data-sid="{{ s.id }}">
          <td class="align-middle text-center">
            <input class="row-checkbox" type="checkbox" value="{{ s.id }}">
          </td>
          <td>
            <div class="mb-1">
              {% if s.status == 'reviewed' %}
                <span class="badge bg-success">Reviewed</span>
              {% elif s.status == 'rejected' %}
                <span class="badge bg-warning text-dark">Rejected</span>
              {% else %}
                <span class="badge bg-secondary">New</span>
              {% endif %}
              <small class="text-muted ms-2">id: {{ s.id }}</small>
            </div>
            <textarea class="form-control sentence-text" data-sid="{{ s.id }}" {% if s.status=='reviewed' %}disabled{% endif %}>{{ s.sentence }}</textarea>
            <div class="form-text">Insert <code>#$#</code> to split (only New/Rejected).</div>
          </td>
          <td>
            <div class="d-grid gap-2">
              <button type="button" class="btn btn-primary btn-sm save-btn" data-sid="{{ s.id }}" {% if s.status=='reviewed' %}disabled{% endif %}>Save</button>
              <button type="button" class="btn btn-danger btn-sm delete-btn" data-sid="{{ s.id }}" {% if s.status=='reviewed' %}disabled{% endif %}>Delete</button>
            </div>
          </td>
        </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="3" class="text-center text-muted">No sentences found for this filter.</td>
      </tr>
    {% endif %}
    </tbody>
    <tfoot class="table-light">
      <tr>
        <th><input id="select-all-bottom" type="checkbox"></th>
        <th colspan="2">Select All</th>
      </tr>
    </tfoot>
  </table>
</form>

<!-- Bottom action buttons -->
<div class="mb-3">
  <button id="mark-reviewed-bottom" class="btn btn-success btn-sm">Mark Reviewed</button>
  <button id="mark-rejected-bottom" class="btn btn-warning btn-sm">Mark Rejected</button>
  <button id="mark-new-bottom" class="btn btn-secondary btn-sm">Mark New</button>
  <button id="delete-selected-bottom" class="btn btn-danger btn-sm">Delete Selected</button>
</div>

<!-- Filter + Page size (BOTTOM) -->
<form method="get" class="mt-3 mb-3 d-flex align-items-center gap-3">
  <input type="hidden" name="page" value="{{ page }}">
  <label for="status-bottom" class="mb-0">Filter:</label>
  <select name="status" id="status-bottom" class="form-select form-select-sm"
          style="max-width:150px;" onchange="this.form.submit()">
    <option value="" {% if not status_filter %}selected{% endif %}>All</option>
    <option value="new" {% if status_filter=='new' %}selected{% endif %}>New</option>
    <option value="reviewed" {% if status_filter=='reviewed' %}selected{% endif %}>Reviewed</option>
    <option value="rejected" {% if status_filter=='rejected' %}selected{% endif %}>Rejected</option>
  </select>

  <label for="page_size-bottom" class="mb-0">Rows per page:</label>
  <select name="page_size" id="page_size-bottom" class="form-select form-select-sm"
          style="max-width:100px;" onchange="this.form.submit()">
    {% for size in [10,25,50,100] %}
      <option value="{{ size }}" {% if page_size|int == size %}selected{% endif %}>{{ size }}</option>
    {% endfor %}
  </select>
</form>

<nav aria-label="Page navigation">
  <ul class="pagination">
    {% if page > 1 %}
      <li class="page-item">
        <a class="page-link"
           href="{{ url_for('view_link', link_id=link_id, page=page-1, status=status_filter or '', page_size=page_size) }}">
          Previous
        </a>
      </li>
    {% endif %}
    <li class="page-item disabled"><span class="page-link">Page {{page}} / {{total_pages}}</span></li>
    {% if page < total_pages %}
      <li class="page-item">
        <a class="page-link"
           href="{{ url_for('view_link', link_id=link_id, page=page+1, status=status_filter or '', page_size=page_size) }}">
          Next
        </a>
      </li>
    {% endif %}
  </ul>
</nav>

<!-- Sticky footer action bar -->
<div id="action-footer" class="bg-light border-top p-2 d-flex justify-content-around align-items-center"
     style="position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000;">
  <button id="mark-reviewed-footer" class="btn btn-sm btn-success" title="Mark Reviewed">
    <i class="bi bi-check-circle"></i>
  </button>
  <button id="mark-rejected-footer" class="btn btn-sm btn-warning" title="Mark Rejected">
    <i class="bi bi-x-circle"></i>
  </button>
  <button id="mark-new-footer" class="btn btn-sm btn-secondary" title="Mark New">
    <i class="bi bi-plus-circle"></i>
  </button>
  <button id="delete-selected-footer" class="btn btn-sm btn-danger" title="Delete Selected">
    <i class="bi bi-trash"></i>
  </button>
</div>
{% endblock %}

{% block scripts %}
<script>
async function postJSON(url, body) {
  const resp = await fetch(url, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });
  return resp.json();
}

// Select-all sync
function toggleSelectAll(masterId) {
  const master = document.getElementById(masterId);
  master.addEventListener('change', function() {
    const checked = this.checked;
    document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = checked);
    // sync both checkboxes
    if (masterId === 'select-all-top') {
      document.getElementById('select-all-bottom').checked = checked;
    } else {
      document.getElementById('select-all-top').checked = checked;
    }
  });
}
toggleSelectAll('select-all-top');
toggleSelectAll('select-all-bottom');

// Save button handler
document.querySelectorAll('.save-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const sid = Number(btn.dataset.sid);
    const ta = document.querySelector('textarea[data-sid="'+sid+'"]');
    const res = await postJSON('{{ url_for("api_update_sentence") }}', { id: sid, sentence: ta.value.trim() });
    if (res.ok) location.reload();
    else alert('Update failed: ' + (res.error || 'unknown'));
  });
});

// Delete button handler
document.querySelectorAll('.delete-btn').forEach(btn => {
  btn.addEventListener('click', async () => {
    const sid = Number(btn.dataset.sid);
    if (!confirm('Delete id '+sid+'?')) return;
    const res = await postJSON('{{ url_for("api_delete_sentences") }}', { ids: [sid] });
    if (res.ok) location.reload();
    else alert('Delete failed');
  });
});

// Bulk status changes
async function changeStatusForChecked(status) {
  const checked = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(i => Number(i.value));
  if (!checked.length) { alert('No sentences selected'); return; }
  const res = await postJSON('{{ url_for("api_change_status") }}', { ids: checked, status: status });
  if (res.ok) location.reload();
  else alert('Status change failed');
}

// Top buttons
document.getElementById('mark-reviewed').addEventListener('click', () => changeStatusForChecked('reviewed'));
document.getElementById('mark-rejected').addEventListener('click', () => changeStatusForChecked('rejected'));
document.getElementById('mark-new').addEventListener('click', () => changeStatusForChecked('new'));
document.getElementById('delete-selected').addEventListener('click', () => changeStatusForChecked('delete'));

// Bottom buttons reuse
document.getElementById('mark-reviewed-bottom').addEventListener('click', () => changeStatusForChecked('reviewed'));
document.getElementById('mark-rejected-bottom').addEventListener('click', () => changeStatusForChecked('rejected'));
document.getElementById('mark-new-bottom').addEventListener('click', () => changeStatusForChecked('new'));
document.getElementById('delete-selected-bottom').addEventListener('click', () => changeStatusForChecked('delete'));

// Sticky footer buttons
document.getElementById('mark-reviewed-footer').addEventListener('click', () => changeStatusForChecked('reviewed'));
document.getElementById('mark-rejected-footer').addEventListener('click', () => changeStatusForChecked('rejected'));
document.getElementById('mark-new-footer').addEventListener('click', () => changeStatusForChecked('new'));
document.getElementById('delete-selected-footer').addEventListener('click', () => changeStatusForChecked('delete'));

</script>
{% endblock %}
